{% extends "base.html" %}

{% block title %}{{ equipment.name }} - Equipment Status Board{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('equipment.index') }}">Equipment Registry</a></li>
        <li class="breadcrumb-item active" aria-current="page">{{ equipment.name }}</li>
    </ol>
</nav>

{% if equipment.is_archived %}
<div class="alert alert-warning" role="alert">
    This equipment has been archived and is no longer active.
</div>
{% endif %}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>{{ equipment.name }}</h1>
    {% if not equipment.is_archived %}
    <div class="d-flex gap-2">
        <a href="{{ url_for('repairs.create', equipment_id=equipment.id) }}" class="btn btn-outline-primary btn-sm">Report Issue</a>
        {% if current_user.role == 'staff' %}
        <a href="{{ url_for('equipment.edit', id=equipment.id) }}" class="btn btn-outline-secondary">Edit</a>
        <form method="post" action="{{ url_for('equipment.archive', id=equipment.id) }}" class="d-inline">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to archive this equipment? It will be removed from active lists.')">Archive</button>
        </form>
        {% endif %}
    </div>
    {% endif %}
</div>

<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Equipment Information</h5>
    </div>
    <div class="card-body">
        <dl class="row mb-0">
            <dt class="col-sm-3">Name</dt>
            <dd class="col-sm-9">{{ equipment.name }}</dd>

            <dt class="col-sm-3">Manufacturer</dt>
            <dd class="col-sm-9">{{ equipment.manufacturer }}</dd>

            <dt class="col-sm-3">Model</dt>
            <dd class="col-sm-9">{{ equipment.model }}</dd>

            <dt class="col-sm-3">Area</dt>
            <dd class="col-sm-9">{{ equipment.area.name }}</dd>
        </dl>
    </div>
</div>

{% if equipment.serial_number or equipment.acquisition_date or equipment.acquisition_source or equipment.acquisition_cost is not none or equipment.warranty_expiration or equipment.description %}
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Additional Details</h5>
    </div>
    <div class="card-body">
        <dl class="row mb-0">
            {% if equipment.serial_number %}
            <dt class="col-sm-3">Serial Number</dt>
            <dd class="col-sm-9">{{ equipment.serial_number }}</dd>
            {% endif %}

            {% if equipment.acquisition_date %}
            <dt class="col-sm-3">Acquisition Date</dt>
            <dd class="col-sm-9">{{ equipment.acquisition_date|format_date }}</dd>
            {% endif %}

            {% if equipment.acquisition_source %}
            <dt class="col-sm-3">Acquisition Source</dt>
            <dd class="col-sm-9">{{ equipment.acquisition_source }}</dd>
            {% endif %}

            {% if equipment.acquisition_cost is not none %}
            <dt class="col-sm-3">Acquisition Cost</dt>
            <dd class="col-sm-9">${{ "%.2f"|format(equipment.acquisition_cost) }}</dd>
            {% endif %}

            {% if equipment.warranty_expiration %}
            <dt class="col-sm-3">Warranty Expiration</dt>
            <dd class="col-sm-9">{{ equipment.warranty_expiration|format_date }}</dd>
            {% endif %}

            {% if equipment.description %}
            <dt class="col-sm-3">Description</dt>
            <dd class="col-sm-9">{{ equipment.description }}</dd>
            {% endif %}
        </dl>
    </div>
</div>
{% endif %}

{# --- Documents Section --- #}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Documents</h5>
        {% if can_edit_docs %}
        <button class="btn btn-sm btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#upload-doc-form">
            Upload Document
        </button>
        {% endif %}
    </div>
    <div class="card-body">
        {% if can_edit_docs %}
        <div class="collapse mb-3" id="upload-doc-form">
            <form method="post" action="{{ url_for('equipment.upload_document', id=equipment.id) }}" enctype="multipart/form-data">
                {{ doc_form.hidden_tag() }}
                <div class="row g-2 align-items-end">
                    <div class="col-12 col-md-5">
                        <label for="{{ doc_form.file.id }}" class="form-label">File *</label>
                        {{ doc_form.file(class="form-control") }}
                    </div>
                    <div class="col-12 col-md-4">
                        <label for="{{ doc_form.category.id }}" class="form-label">Category *</label>
                        {{ doc_form.category(class="form-select") }}
                    </div>
                    <div class="col-12 col-md-3">
                        {{ doc_form.submit(class="btn btn-primary w-100") }}
                    </div>
                </div>
            </form>
        </div>
        {% endif %}

        {% if documents %}
        <div class="list-group">
            {% for doc in documents %}
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    {% if doc.category %}
                    <span class="badge bg-secondary me-2">{{ doc.category|category_label }}</span>
                    {% endif %}
                    <a href="{{ url_for('equipment.serve_document', id=equipment.id, filename=doc.stored_filename) }}">
                        {{ doc.original_filename }}
                    </a>
                    <small class="text-muted ms-2">
                        {{ doc.size_bytes|filesize }}
                        &middot; {{ doc.uploaded_by }}
                        &middot; {{ doc.created_at.strftime('%Y-%m-%d') }}
                    </small>
                </div>
                {% if can_edit_docs %}
                <form method="post" action="{{ url_for('equipment.delete_document', id=equipment.id, doc_id=doc.id) }}" class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('Are you sure you want to delete this document?')">Delete</button>
                </form>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-muted text-center mb-0">No documents attached yet.</p>
        {% endif %}
    </div>
</div>

{# --- Photos Section --- #}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Photos</h5>
        {% if can_edit_docs %}
        <button class="btn btn-sm btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#upload-photo-form">
            Upload Photo
        </button>
        {% endif %}
    </div>
    <div class="card-body">
        {% if can_edit_docs %}
        <div class="collapse mb-3" id="upload-photo-form">
            <form method="post" action="{{ url_for('equipment.upload_photo', id=equipment.id) }}" enctype="multipart/form-data">
                {{ photo_form.hidden_tag() }}
                <div class="row g-2 align-items-end">
                    <div class="col-12 col-md-9">
                        <label for="{{ photo_form.file.id }}" class="form-label">Photo/Video *</label>
                        {{ photo_form.file(class="form-control") }}
                    </div>
                    <div class="col-12 col-md-3">
                        {{ photo_form.submit(class="btn btn-primary w-100") }}
                    </div>
                </div>
            </form>
        </div>
        {% endif %}

        {% if photos %}
        <div class="row g-3">
            {% for photo in photos %}
            <div class="col-6 col-md-4 col-lg-3">
                <div class="card h-100">
                    {% set ext = photo.original_filename.rsplit('.', 1)[-1].lower() %}
                    {% if ext in ['jpg', 'jpeg', 'png', 'gif', 'webp'] %}
                    <img src="{{ url_for('equipment.serve_photo', id=equipment.id, filename=photo.stored_filename) }}"
                         class="card-img-top" alt="{{ photo.original_filename }}"
                         style="max-height: 200px; object-fit: cover;">
                    {% else %}
                    <div class="card-img-top d-flex align-items-center justify-content-center bg-light" style="height: 200px;">
                        <span class="text-muted fs-1">&#128249;</span>
                    </div>
                    {% endif %}
                    <div class="card-body p-2">
                        <small class="text-truncate d-block">{{ photo.original_filename }}</small>
                        <small class="text-muted d-block">
                            {{ photo.size_bytes|filesize }}
                            &middot; {{ photo.uploaded_by }}
                            &middot; {{ photo.created_at.strftime('%Y-%m-%d') }}
                        </small>
                        {% if can_edit_docs %}
                        <form method="post" action="{{ url_for('equipment.delete_photo', id=equipment.id, photo_id=photo.id) }}" class="mt-1">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-outline-danger btn-sm w-100" onclick="return confirm('Are you sure you want to delete this photo?')">Delete</button>
                        </form>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-muted text-center mb-0">No photos attached yet.</p>
        {% endif %}
    </div>
</div>

{# --- Links Section --- #}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Links</h5>
        {% if can_edit_docs %}
        <button class="btn btn-sm btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#add-link-form">
            Add Link
        </button>
        {% endif %}
    </div>
    <div class="card-body">
        {% if can_edit_docs %}
        <div class="collapse mb-3" id="add-link-form">
            <form method="post" action="{{ url_for('equipment.add_link', id=equipment.id) }}">
                {{ link_form.hidden_tag() }}
                <div class="row g-2 align-items-end">
                    <div class="col-12 col-md-4">
                        <label for="{{ link_form.title.id }}" class="form-label">Title *</label>
                        {{ link_form.title(class="form-control", placeholder="Link title") }}
                    </div>
                    <div class="col-12 col-md-5">
                        <label for="{{ link_form.url.id }}" class="form-label">URL *</label>
                        {{ link_form.url(class="form-control", placeholder="https://...") }}
                    </div>
                    <div class="col-12 col-md-3">
                        {{ link_form.submit(class="btn btn-primary w-100") }}
                    </div>
                </div>
            </form>
        </div>
        {% endif %}

        {% if links %}
        <div class="list-group">
            {% for link in links %}
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <a href="{{ link.url }}" target="_blank" rel="noopener noreferrer">{{ link.title }}</a>
                    <small class="text-muted ms-2">
                        {{ link.created_by }}
                        &middot; {{ link.created_at.strftime('%Y-%m-%d') }}
                    </small>
                </div>
                {% if can_edit_docs %}
                <form method="post" action="{{ url_for('equipment.delete_link', id=equipment.id, link_id=link.id) }}" class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('Are you sure you want to delete this link?')">Delete</button>
                </form>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-muted text-center mb-0">No links added yet.</p>
        {% endif %}
    </div>
</div>
{% endblock %}
