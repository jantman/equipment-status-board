name: Release

on:
  push:
    branches: [main]

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check version vs. latest release
        id: version_check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          CURRENT_VERSION=$(python3 -c "
          import re, pathlib
          text = pathlib.Path('pyproject.toml').read_text()
          m = re.search(r'^version\s*=\s*\"([^\"]+)\"', text, re.MULTILINE)
          print(m.group(1))
          ")
          echo "current_version=$CURRENT_VERSION" >> "$GITHUB_OUTPUT"

          LATEST_TAG=$(gh release list --limit 1 --json tagName --jq '.[0].tagName // empty' 2>/dev/null || true)

          if [ -z "$LATEST_TAG" ]; then
            echo "No existing releases found â€” first release"
            echo "should_release=true" >> "$GITHUB_OUTPUT"
          else
            LATEST_VERSION="${LATEST_TAG#v}"
            SHOULD=$(python3 -c "
          current = tuple(int(x) for x in '$CURRENT_VERSION'.split('.'))
          latest = tuple(int(x) for x in '$LATEST_VERSION'.split('.'))
          print('true' if current > latest else 'false')
          ")
            echo "Latest release: $LATEST_TAG, current version: $CURRENT_VERSION, should_release: $SHOULD"
            echo "should_release=$SHOULD" >> "$GITHUB_OUTPUT"
          fi

      - name: Set up Docker Buildx
        if: steps.version_check.outputs.should_release == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        if: steps.version_check.outputs.should_release == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        if: steps.version_check.outputs.should_release == 'true'
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:latest
            ghcr.io/${{ github.repository }}:${{ steps.version_check.outputs.current_version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Create git tag
        if: steps.version_check.outputs.should_release == 'true'
        run: |
          VERSION="${{ steps.version_check.outputs.current_version }}"
          git tag "v$VERSION"
          git push origin "v$VERSION"

      - name: Create GitHub Release
        if: steps.version_check.outputs.should_release == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.version_check.outputs.current_version }}"
          TAG="v$VERSION"
          REPO="${{ github.repository }}"

          # Generate changelog via GitHub API
          CHANGELOG=$(gh api \
            "repos/$REPO/releases/generate-notes" \
            -f tag_name="$TAG" \
            -f target_commitish="main" \
            --jq '.body')

          # Build release body in a file to avoid shell escaping issues
          {
            printf '%s\n' "$CHANGELOG"
            printf '\n---\n\n## Docker Image\n\n```bash\n'
            printf 'docker pull ghcr.io/%s:%s\n' "$REPO" "$VERSION"
            printf 'docker pull ghcr.io/%s:latest\n' "$REPO"
            printf '```\n'
          } > /tmp/release_body.md

          gh release create "$TAG" \
            --title "$TAG" \
            --notes-file /tmp/release_body.md
