{% extends "base.html" %}

{% block title %}Repair #{{ record.id }} - Equipment Status Board{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('repairs.index') }}">Repairs</a></li>
        <li class="breadcrumb-item active" aria-current="page">Repair #{{ record.id }}</li>
    </ol>
</nav>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>Repair #{{ record.id }}</h1>
    <div>
        <a href="{{ url_for('repairs.edit', id=record.id) }}" class="btn btn-primary">Edit</a>
        <span class="badge bg-{{ 'danger' if record.severity == 'Down' else ('warning text-dark' if record.severity in ['Degraded', 'Not Sure'] else 'secondary') }}">
            {{ record.severity or 'No Severity' }}
        </span>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header"><h5 class="mb-0">Repair Information</h5></div>
    <div class="card-body">
        <dl class="row mb-0">
            <dt class="col-sm-3">Equipment</dt>
            <dd class="col-sm-9">
                <a href="{{ url_for('equipment.detail', id=record.equipment.id) }}">
                    {{ record.equipment.name }}
                </a>
                ({{ record.equipment.area.name }})
            </dd>
            <dt class="col-sm-3">Status</dt>
            <dd class="col-sm-9"><span class="badge bg-info text-dark">{{ record.status }}</span></dd>
            <dt class="col-sm-3">Severity</dt>
            <dd class="col-sm-9">{{ record.severity or 'Not set' }}</dd>
            <dt class="col-sm-3">Assignee</dt>
            <dd class="col-sm-9">{{ record.assignee.username if record.assignee else 'Unassigned' }}</dd>
            {% if record.eta %}
            <dt class="col-sm-3">ETA</dt>
            <dd class="col-sm-9">{{ record.eta.strftime('%Y-%m-%d') }}</dd>
            {% endif %}
            {% if record.specialist_description %}
            <dt class="col-sm-3">Specialist Description</dt>
            <dd class="col-sm-9">{{ record.specialist_description }}</dd>
            {% endif %}
            {% if record.has_safety_risk %}
            <dt class="col-sm-3">Safety Risk</dt>
            <dd class="col-sm-9"><span class="badge bg-danger">SAFETY RISK</span></dd>
            {% endif %}
            <dt class="col-sm-3">Description</dt>
            <dd class="col-sm-9">{{ record.description }}</dd>
            <dt class="col-sm-3">Created</dt>
            <dd class="col-sm-9">{{ record.created_at.strftime('%Y-%m-%d %H:%M') }}</dd>
        </dl>
    </div>
</div>

{# --- Add Note Form --- #}
<div class="card mb-3">
    <div class="card-body">
        <form method="post" action="{{ url_for('repairs.add_note', id=record.id) }}">
            {{ note_form.hidden_tag() }}
            <div class="mb-2">
                <label for="note" class="form-label">Add a Note</label>
                {{ note_form.note(class="form-control" ~ (" is-invalid" if note_form.note.errors else ""), rows="3", placeholder="Type your diagnostic notes here...") }}
                {% for error in note_form.note.errors %}
                <div class="invalid-feedback">{{ error }}</div>
                {% endfor %}
            </div>
            {{ note_form.submit(class="btn btn-primary") }}
        </form>
    </div>
</div>

{# --- Upload Photo Form --- #}
<div class="card mb-3">
    <div class="card-body">
        <form method="post" action="{{ url_for('repairs.upload_photo', id=record.id) }}" enctype="multipart/form-data">
            {{ photo_form.hidden_tag() }}
            <div class="row g-2 align-items-end">
                <div class="col">
                    <label for="{{ photo_form.file.id }}" class="form-label">Upload Diagnostic Photo</label>
                    {{ photo_form.file(class="form-control") }}
                </div>
                <div class="col-auto">
                    {{ photo_form.submit(class="btn btn-primary") }}
                </div>
            </div>
        </form>
    </div>
</div>

<h3>Timeline</h3>
<ol class="list-group mb-4">
    {% for entry in timeline %}
    {% include 'components/_timeline_entry.html' %}
    {% endfor %}
</ol>
{% endblock %}
